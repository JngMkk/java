## 자바 가상머신의 메모리 모델

### 가상머신은 운영체제 위에서 동작

- 자바 가상머신은 운영체제 위에서 실행되는 하나의 프로그램이다.
- 자바 프로그램은 자바 가상머신 위에서 실행되는 프로그램이다.

```
가상머신의 실행에 필요한 메모리는 어떻게 제공되는 것인가?
프로그램의 실행에 필요한 메모리 공간을 가리켜 '메인 메모리'라 하며, 이는 물리적으로 RAM을 의미함.
그리고 이 메모리의 효율적인 사용을 위해 윈도우, 리눅스와 같은 운영체제가 메모리를 관리함.
즉 운영체제가 응용 프로그램에게 메모리를 할당해 주는 것임.
```



### 자바 가상머신의 메모리 사용

```
가상머신은 운영체제로부터 할당받은 메모리 공간의 효율적인 사용을 고민해야 함.
프로그램의 실행을 위해서 메모리 공간을 나누고 데이터를 특성에 따라 구분해서 저장해야 함.

메서드 영역 - 스택 영역 - 힙 영역

메서드 영역: 메서드의 바이트코드, static 변수
스택 영역: 지역변수, 매개변수
힙 영역: 인스턴스
```

- 메서드 영역

  ```
  소스파일을 컴파일할 때 생성되는, 자바 가상머신에 의해 실행이 가능한 코드를 가리켜 '바이트코드'라 함.
  그리고 이 바이트코드도 메모리 공간에 존재해야 실행이 가능함.
  ```

  ```java
  class Boy {
    static int average = 0;
    public void Run() { ... }
  }
  
  class MyMain {
    public static void main(String[] args) {
      Boy b = new Boy();		// 인스턴스 생성
      Boy.average += 5;			// 클래스 변수 접근
      ...
    }
  }
  ```

  ```
  위의 main 메서드에서는 Boy 인스턴스를 생성하고 또 Boy의 클래스 변수에 접근하고 있음.
  이렇듯 인스턴스의 생성 및 클래스 변수의 접근을 위해서는 먼저 해당 클래스의 바이트코드가 메모리 공간에 로딩되어야 하는데,
  이때 로딩되는 메모리 공간이 '메서드 영역'임.
  즉, 메서드 영역은 특정 클래스의 정보가 메모리 공간에 올려질 때 채워지는 영역.
  ```

- 스택 영역

  ```
  스택은 지역변수와 매개변수가 저장되는 공간.
  중괄호 내에 할당된 이후에 해당 중괄호를 벗어나면 바로 소멸되는 특성의 데이터 저장을 위한 영역이 '스택'.
  ```

  ```java
  class MyMain {
  	public static void main(String[] args) {
    	int num1 = 10;
  	  int num2 = 20;
    	adder(num1, num2);
  	}
    public static void adder(int n1, int n2) {
      int result = n1 + n2;
      return result;
    }
  }
  ```

  ```
  스택 할당 순서: (main에 의한 할당) args -> num1 -> num2
  						(메서드 adder에 의한 할당) n1 -> n2 -> result
  반환 순서: [result -> n2 -> n1] 반환 -> ...
  ```

- 힙 영역

  ```
  인스턴스는 힙 영역에 할당됨.
  스택이 아닌 힙이라는 별도의 영역에 할당되는 이유는 인스턴스의 소멸 시점과 소멸 방법이 지역변수와 다르기 때문.
  ```

  ```java
  public static void simpleMethod() {
    String str1 = new String("My String");
    String str2 = new String("Your String");
    ...
  }
  ```

  ```
  위 코드에서 String 인스턴스의 생성문이 메서드 내에 존재하므로 str1과 str2는 참조변수이자 지역변수임.
  따라서 이 둘은 스택에 할당됨.
  그러나 인스턴스는 무조건 힙에 할당되는 메모리 공간에는 참조 관계가 형성됨.
  
  (스택 영역)		(참조)		(힙 영역)
  	str1			 ->		  "My String"
  	str2       ->     "Your String"
  	
  인스턴스의 소멸시기를 결정하는 것은 가상머신의 역할.
  즉 가상머신이 인스턴스 소멸을 결정하면 인스턴스는 자동으로 소멸됨.
  ```

  - 자바 가상머신의 인스턴스 소멸시기

    > 자바 가상머신은 합리적으로 인스턴스의 소멸시기를 결정함.

    ```java
    public static void simpleMethod() {
      String str1 = new String("My String");
      String str2 = new String("Your String");
      ...
      str1 = null;		// 참조 관계 소멸
      str2 = null;		// 참조 관계 소멸
    }
    ```

    ```
    str1과 str2에 null을 대입하면 두 String 인스턴스는 어느 참조변수도 참조하지 않는 상태가 됨.
    이러한 상태의 인스턴스는 존재할 이유가 없음. 더 이상 접근할 수 없는 인스턴스이기 때문.
    때문에 이러한 상태의(아무런 참조변수도 참조하지 않는 상태의) 인스턴스는 '소멸의 대상'이 되어 가상머신에 의해 소멸이 이뤄짐.
    이러한 소멸 방식을 가리켜 Garbage Collection이라 함.
    힙 영역은 가상머신에 의한 가비지 컬렉션이 일어나는 메모리 공간이라 할 수 있음.
    
    인스턴스가 가비지 컬렉션의 대상이 되었다고 해서 바로 소멸이 되는 것은 아님.
    가비지 컬렉션의 빈번한 실행은 시스템에 부담이기 때문에 성능에 영향을 미치지 않도록 가비지 컬렉션의 실행 타이밍은 별도의 알고리즘을 기반으로 계산되며,
    이 계산 결과를 기반으로 가비지 컬렉션이 수행됨.
    ```

    

    